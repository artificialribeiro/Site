<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de API | Produtos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <style>
        body { background-color: #050505; color: #fff; font-family: monospace; }
        
        pre {
            background-color: #111;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            color: #4ade80; 
            font-size: 13px;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="p-8">

    <div class="max-w-7xl mx-auto">
        
        <div class="flex items-center justify-between mb-8 border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Painel de Teste de API</h1>
                <p class="text-gray-500 text-sm">Validando retorno do endpoint: <span class="text-blue-400">/api/produtos</span></p>
            </div>
            
            <button id="btnCarregar" class="bg-white text-black px-6 py-3 rounded font-bold hover:bg-gray-200 transition-colors">
                Fazer Requisi√ß√£o
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl text-gray-300 flex items-center gap-2">
                        üìÑ Retorno Bruto
                    </h2>
                    
                    <div class="flex gap-2">
                        <button id="btnCopiar" class="hidden flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded text-xs transition-colors">
                            <span class="material-symbols-outlined text-[16px]">content_copy</span> Copiar
                        </button>
                        <button id="btnBaixar" class="hidden flex items-center gap-2 bg-blue-900 hover:bg-blue-800 text-blue-100 px-3 py-1.5 rounded text-xs transition-colors border border-blue-700">
                            <span class="material-symbols-outlined text-[16px]">download</span> Baixar TXT
                        </button>
                    </div>
                </div>
                <pre id="jsonOutput">Clique no bot√£o acima para carregar...</pre>
            </div>

            <div>
                <h2 class="text-xl mb-4 text-gray-300 flex items-center gap-2">
                    üëÅÔ∏è Renderiza√ß√£o Visual
                </h2>
                <div id="visualOutput" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                    <div class="p-6 border border-gray-800 border-dashed text-gray-600 text-center rounded-lg">
                        Aguardando dados...
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { getAuthHeaders, API_CONFIG } from './chavetoken.js';

        const btnCarregar = document.getElementById('btnCarregar');
        const btnCopiar = document.getElementById('btnCopiar');
        const btnBaixar = document.getElementById('btnBaixar');
        const jsonOutput = document.getElementById('jsonOutput');
        const visualOutput = document.getElementById('visualOutput');

        function resolverImagem(caminho) {
            if (!caminho) return 'https://via.placeholder.com/150/111/fff?text=Sem+Foto';
            if (caminho.startsWith('data:image')) return caminho;
            if (/^[a-zA-Z0-9+/]+={0,2}$/.test(caminho) && caminho.length > 200) return `data:image/jpeg;base64,${caminho}`;
            if (caminho.startsWith('http')) return caminho;
            if (caminho.startsWith('/')) return `${API_CONFIG.baseUrl}${caminho}`;
            return `${API_CONFIG.baseUrl}/${caminho}`;
        }

        // --- FUN√á√ÉO: COPIAR ---
        btnCopiar.addEventListener('click', () => {
            navigator.clipboard.writeText(jsonOutput.innerText).then(() => {
                const conteudoOriginal = btnCopiar.innerHTML;
                btnCopiar.innerHTML = `<span class="material-symbols-outlined text-[16px]">check</span> Copiado!`;
                btnCopiar.classList.replace('bg-gray-800', 'bg-green-600');
                
                setTimeout(() => {
                    btnCopiar.innerHTML = conteudoOriginal;
                    btnCopiar.classList.replace('bg-green-600', 'bg-gray-800');
                }, 2000);
            });
        });

        // --- FUN√á√ÉO: BAIXAR TXT ---
        btnBaixar.addEventListener('click', () => {
            const texto = jsonOutput.innerText;
            // Cria um "arquivo virtual" com o texto
            const blob = new Blob([texto], { type: "text/plain;charset=utf-8" });
            const link = document.createElement("a");
            
            // Cria o link de download e clica nele automaticamente
            link.href = URL.createObjectURL(blob);
            link.download = "retorno_api.txt";
            document.body.appendChild(link);
            link.click();
            
            // Limpa a mem√≥ria depois de baixar
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        });

        // --- FUN√á√ÉO PRINCIPAL: TESTAR API ---
        async function testarAPI() {
            btnCarregar.innerText = "Carregando...";
            btnCarregar.disabled = true;
            btnCopiar.classList.add('hidden');
            btnBaixar.classList.add('hidden');
            
            jsonOutput.innerText = "Conectando ao servidor...\nObtendo token...";
            visualOutput.innerHTML = "<div class='text-gray-500'>Processando renderiza√ß√£o...</div>";

            try {
                const headers = await getAuthHeaders();
                
                jsonOutput.innerText = "Token obtido!\nBuscando produtos...";
                const response = await fetch(`${API_CONFIG.baseUrl}/api/produtos?page=1&pageSize=10`, {
                    method: 'GET',
                    headers: headers
                });

                const result = await response.json();

                // Mostra o JSON cru na tela
                jsonOutput.innerText = JSON.stringify(result, null, 2);
                
                // Exibe os bot√µes de a√ß√£o agora que temos dados
                btnCopiar.classList.remove('hidden');
                btnBaixar.classList.remove('hidden');

                if (result.success && result.data && result.data.length > 0) {
                    visualOutput.innerHTML = result.data.map(p => {
                        const qtdFotos = p.imagens ? p.imagens.length : 0;
                        const urlFoto1 = qtdFotos > 0 ? resolverImagem(p.imagens[0].url) : resolverImagem(null);
                        
                        return `
                            <div class="bg-[#111] p-4 rounded-lg border border-gray-800 flex gap-4 items-start">
                                <div class="w-24 h-32 bg-black border border-gray-700 flex-shrink-0 overflow-hidden rounded">
                                    <img src="${urlFoto1}" alt="Teste" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <h3 class="font-bold text-white text-lg">${p.nome}</h3>
                                    <p class="text-gray-400 text-sm">ID: ${p.id} | SKU: ${p.sku || 'N/A'}</p>
                                    <p class="text-gray-400 text-sm">Categoria: ${p.categoria ? p.categoria.nome : 'N/A'}</p>
                                    <p class="text-green-400 mt-2 font-bold">R$ ${p.preco.toFixed(2)}</p>
                                    <p class="text-xs text-gray-500 mt-2">Fotos recebidas: ${qtdFotos}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    visualOutput.innerHTML = "<div class='text-yellow-500'>A API respondeu, mas n√£o enviou nenhum produto na lista.</div>";
                }

            } catch (error) {
                jsonOutput.innerText = `ERRO FATAL:\n\n${error.message}\n\nVerifique se o servidor backend (localhost:1535) est√° rodando.`;
                visualOutput.innerHTML = `<div class='text-red-500'>Falha na requisi√ß√£o.</div>`;
                console.error(error);
            } finally {
                btnCarregar.innerText = "Fazer Requisi√ß√£o";
                btnCarregar.disabled = false;
            }
        }

        btnCarregar.addEventListener('click', testarAPI);

    </script>
</body>
</html>
